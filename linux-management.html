<div class="header">
  <h1 class="page-title">
    <a class="icon circle-icon glyphicon glyphicon-chevron-left trigger-message-close"></a>
    集群管理笔记
  </h1>
  <div class="details">
    <div class="left">
      12月 04, 2014
      <span> | </span> <a href="/category/xiao-chao-su-cha.html">小抄速查</a>
    </div>
    <div class="right">
      <a class="fa fa-tag" href="/tag/linux.html">linux</a>
      <a class="fa fa-tag" href="/tag/centos.html">centos</a>
      <a class="fa fa-tag" href="/tag/shell.html">shell</a>
      <a class="fa fa-tag" href="/tag/hpc.html">hpc</a>
      <a class="fa fa-tag" href="/tag/rocks-cluster.html">rocks cluster</a>
      <a class="fa fa-tag" href="/tag/manage.html">manage</a>
    </div>
  </div>
</div>
<div id="message-nano-wrapper" class="nano">
  <div class="nano-content">
    <ul class="message-container">
        <div class="message">
          <h1>常用操作</h1>
<h2>电源</h2>
<table>
<thead>
<tr>
<th>插座</th>
<th>1孔</th>
<th>2孔</th>
<th>3孔</th>
<th>4孔</th>
<th>5孔</th>
<th>6孔</th>
<th>7孔</th>
<th>8孔</th>
</tr>
</thead>
<tbody>
<tr>
<td>4号</td>
<td>1上</td>
<td>1下</td>
<td>2下</td>
<td>4上</td>
<td>2上</td>
<td>3下</td>
<td>3上</td>
<td>插座3号</td>
</tr>
<tr>
<td>3号</td>
<td></td>
<td></td>
<td>8下</td>
<td>8上</td>
<td>7下</td>
<td>7上</td>
<td>大右</td>
<td>大左</td>
</tr>
<tr>
<td>2号</td>
<td>4下</td>
<td>显</td>
<td>交下</td>
<td>5下</td>
<td>交上</td>
<td>5上</td>
<td></td>
<td></td>
</tr>
<tr>
<td>1号</td>
<td>插座2号</td>
<td>小右</td>
<td>6左</td>
<td>外下</td>
<td>管上</td>
<td>6右</td>
<td>管下</td>
<td>小左</td>
</tr>
</tbody>
</table>
<h2>清理内存</h2>
<div class="highlight"><pre><span class="code-line"><span></span><span class="nb">echo</span> <span class="m">1</span> &gt; /proc/sys/vm/drop_caches</span>
</pre></div>


<h2><a href="terminal-announcement">登录显示信息</a></h2>
<h2>158挂载swap</h2>
<div class="highlight"><pre><span class="code-line"><span></span>mount /dev/sdc1 /extra</span>
</pre></div>


<h2>核心数</h2>
<p>/proc/cpuinfo 用来存储cpu硬件信息
一颗cpu可以有多核，加上intel的超线程技术(HT), 可以在逻辑上再分一倍数量的cpu core出来
<strong>逻辑CPU数量 = 物理cpu数量 × cpu 核数 x 2(如果支持并开启ht)</strong></p>
<table>
<thead>
<tr>
<th align="center">逻辑CPU</th>
<th align="center">物理CPU</th>
<th align="center">CPU核数</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">最大线程数</td>
<td align="center">实际服务器插槽上的CPU数目</td>
<td align="center">CPU核心数</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>逻辑CPU数</p>
<div class="highlight"><pre><span class="code-line"><span></span>cat /proc/cpuinfo|grep &quot;processor&quot;|wc</span>
</pre></div>


</li>
<li>
<p>物理CPU数</p>
<div class="highlight"><pre><span class="code-line"><span></span>cat /proc/cpuinfo|grep &quot;physical\ id&quot;|sort -u|wc</span>
</pre></div>


</li>
<li>
<p>CPU核数</p>
<div class="highlight"><pre><span class="code-line"><span></span>cat /proc/cpuinfo|grep &quot;cores&quot;|sort -u</span>
</pre></div>


</li>
<li>
<p>GPU计算卡</p>
<div class="highlight"><pre><span class="code-line"><span></span>lspci | grep NVIDIA</span>
</pre></div>


</li>
</ul>
<h2>硬盘</h2>
<ul>
<li>
<p>Raid0: 最少需要<strong>2块</strong>盘，没用冗余数据,不做备份，任何一块磁盘损坏都无法运行。n块磁盘（同类型）的阵列理论上读写速度是单块磁盘的n倍(实际达不到)，风险性也是单一n倍（实际更高），是磁盘阵列中存储性能最好的。适用于安全性不高，要求比较高性能的图形工作站或者个人站。</p>
</li>
<li>
<p>Raid1：至少需要<em>2块</em>*盘，磁盘数量是2的n倍，每一块磁盘要有对应的备份盘，利用率是50%，只要有一对磁盘没有损坏就可以正常使用。n组磁盘（2n块同类型磁盘）的阵列理论上读取速度是单块磁盘的n倍（实际达不到），风险性是单一磁盘的n分之一（实际更低）。换盘后需要长时间的镜像同步，不影响外界访问，但整个系统性能下降。磁盘控制器负载比较大。适用于安全性较高，且能较快恢复数据的场合。</p>
</li>
<li>
<p>Raid10：至少需要<strong>4块</strong>盘，磁盘数量也是2的n倍。既有数据镜像备份，也能保证较高的读写速度。成本比较大。</p>
</li>
<li>
<p>Raid3：至少需要<strong>3块</strong>盘（2块盘没有校验的意义）。将数据存放在n+1块盘上，有效空间是n块盘的总和，最后一块存储校验信息。数据被分割存储在n块盘上，任一数据盘出现问题，可由其他数据盘通过校正监测恢复数据（可以带伤工作），换数据盘需要重新恢复完整的校验容错信息。对阵列写入时会重写校验盘的内容，对校验盘的负载较大，读写速度相较于Raid0较慢，适用于读取多而写入少的应用环境，比如数据库和web服务器。使用容错算法和分块的大小决定了Raid3在通常情况下用于大文件且安全性要求较高的应用，比如视频编辑、硬盘播出机、大型数据库等。</p>
</li>
<li>
<p>Raid5：至少需要<strong>3块</strong>盘，读取速度接近Raid0，但是安全性更高。安全性上接近Raid1，但是磁盘的利用率更高。可以认为是Raid0和Raid1的一个折中方案。只允许有一块盘出错，可以通过另外多块盘来计算出故障盘的数据，故障之后必须尽快更换。比Raid0+1的磁盘利用率高，是目前比较常用的一种方案。</p>
</li>
<li>
<p>配置</p>
</li>
<li>commput0<ul>
<li>[2.10GHz] * 4 * 8核/CPU * 2线程/核 = 64</li>
<li>1T * 6块 &gt;&gt;&gt; 3T(raid10), 1.9T+792G未知</li>
</ul>
</li>
<li>compute1-4<ul>
<li>[2.60GHz] * 4 * 6核/CPU * 2线程/核 = 48</li>
<li>TeslaK20Xm GPU ，cuda核心数 2688， 内存6G</li>
</ul>
</li>
<li>compute5<ul>
<li>[2.60GHz] * 4 * 6核/CPU * 2线程/核 = 48</li>
</ul>
</li>
<li>compute6<ul>
<li>[2.20GHz] * 4 * 6核/CPU * 2线程/核 = 48</li>
</ul>
</li>
<li>compute7-8<ul>
<li>[2.30GHz] * 4 * 8核/CPU * 2线程/核 = 64</li>
</ul>
</li>
<li>数据线(raid5)<ul>
<li>3T * 3块 &gt;&gt;&gt; 6T</li>
<li>4T * 6块 &gt;&gt;&gt; 18T</li>
<li>8T * 3块 &gt;&gt;&gt; 15T</li>
</ul>
</li>
<li>网线(raid5)<ul>
<li>4T * 5块 &gt;&gt;&gt; 16T</li>
<li>4T * 5块 &gt;&gt;&gt; 16T</li>
<li>8T * 5块 &gt;&gt;&gt; 30T</li>
</ul>
</li>
</ul>
<h2>rocks</h2>
<ol>
<li>
<p>所有节点运行</p>
<div class="highlight"><pre><span class="code-line"><span></span>rocks run host &quot;hostname&quot;</span>
</pre></div>


</li>
<li>
<p>同步配制</p>
<div class="highlight"><pre><span class="code-line"><span></span>rocks sync config</span>
</pre></div>


</li>
<li>
<p>要先重启管理节点然后计算机节点,否则导致数据不同步</p>
<div class="highlight"><pre><span class="code-line"><span></span>rocks run host &quot;/etc/init.d/pbs_mom restart&quot;</span>
</pre></div>


</li>
<li>
<p>添加用户<strong>无法qusb要在/etc/group 添加用户</strong></p>
<div class="highlight"><pre><span class="code-line"><span></span>useradd -g group name <span class="c1">#/etc/passwd name:x:xxx:xxx::/export/home/casual:/bin/bash</span></span>
<span class="code-line">passwd name</span>
<span class="code-line">rocks sync users <span class="c1">#可更改/export/home/name 为 /home/name : /etc/passwd name:x:xxx:xxx::/home/casual:/bin/bash</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="c1">#如果要修改用户名（未测试过）</span></span>
<span class="code-line">usermod -l newName oldName</span>
<span class="code-line">mv /export/home/newName /export/home/oldName</span>
<span class="code-line">usermod -d /export/home/newName -m newName</span>
<span class="code-line">rocks sync users</span>
</pre></div>


</li>
<li>
<p>如果ssh compute 需要输入密码</p>
<div class="highlight"><pre><span class="code-line"><span></span>rm -rf ~/.ssh #然后 退出登录 再登陆 会自动生成新密钥</span>
</pre></div>


</li>
<li>
<p>进入单用户模式</p>
<p>在倒计时5秒时，按任意键出现下图，
<strong>选择如图，按e进入编辑, 最后加上１,回车,按b,root进入系统</strong>
<img alt="图1" src="images/manager1.png" style="height:30%; width:30%;" />
<img alt="图2" src="images/manager2.png" style="height:30%; width:30%;" />
<img alt="图3" src="images/manager3.jpg" style="height:30%; width:30%;" /></p>
</li>
<li>
<p>重装节点</p>
<div class="highlight"><pre><span class="code-line"><span></span>rocks <span class="nb">set</span> host pxeboot compute1 <span class="nv">action</span><span class="o">=</span>install</span>
</pre></div>


</li>
<li>
<p>提交任务后，无运行时间,且qdel: Server could not connect to MOM</p>
<p>由于节点pbs_mom没运行
解决办法是进入节点后运行pbs_mom</p>
</li>
</ol>
<h2>qmgr</h2>
<div class="highlight"><pre><span class="code-line"><span></span>qmgr -c <span class="s2">&quot;print server&quot;</span> <span class="c1"># 输出server的属性</span></span>
<span class="code-line">qmgr -c <span class="s2">&quot;set server query_other_jobs = true&quot;</span> <span class="c1"># qstat可以查看所有用户</span></span>
<span class="code-line">qmgr -c <span class="s2">&quot;set server auto_node_np = True&quot;</span> <span class="c1"># 自动更新节点线程数</span></span>
</pre></div>


<h2>Draining system to allow starving job to run (qstat -s)</h2>
<p>队列中还有排队非常久的饥饿进程，为了更公平合理使用队列，所以将新提交的作业做置为排队状态以让出资源运行排队的饥饿作业</p>
<p>修改/opt/torque/spool/sched_priv/sched_config</p>
<p>before:
help_starving_jobs true ALL</p>
<p>after:
help_starving_jobs false ALL</p>
<div class="highlight"><pre><span class="code-line"><span></span>/opt/torque/init.d/pbs_sched pbs_mom pbs_server</span>
<span class="code-line">service pbs_server restart</span>
</pre></div>


<h2>multipath与iscsi操作</h2>
<ul>
<li>硬件连接及硬盘灯(绿)</li>
<li>
<p>确定服务开启:</p>
<div class="highlight"><pre><span class="code-line"><span></span>service iscsi restart</span>
</pre></div>


</li>
<li>
<p>查看iscsi发现记录</p>
<div class="highlight"><pre><span class="code-line"><span></span>iscsiadm -m node</span>
</pre></div>


</li>
<li>
<p>发现iscsi存储：</p>
<div class="highlight"><pre><span class="code-line"><span></span>iscsiadm -m discovery -t st -p 10.1.1.100:3260</span>
<span class="code-line">iscsiadm -m discovery -t st -p 10.1.1.101:3260</span>
<span class="code-line">iscsiadm -m discovery -t st -p 10.1.1.102:3260</span>
<span class="code-line">iscsiadm -m discovery -t st -p 10.1.1.103:3260</span>
</pre></div>


</li>
<li>
<p>multipath操作</p>
<div class="highlight"><pre><span class="code-line"><span></span>multipath -ll <span class="c1">#查看</span></span>
<span class="code-line">multipath -v2  <span class="c1">#自动更新路径</span></span>
<span class="code-line">multipath -f mpathg <span class="c1"># 删除路径</span></span>
<span class="code-line">service multipathd restart <span class="c1">#重启确认/dev/mapper下有硬盘连接</span></span>
<span class="code-line"><span class="c1"># 挂载</span></span>
<span class="code-line">mount /dev/mapper/mpathep1 /export/data2</span>
<span class="code-line">mount /dev/mapper/mpathfp1 /export/data3</span>
<span class="code-line">mount /dev/mapper/mpathhp1 /export/data4</span>
</pre></div>


</li>
<li>
<p>挂载fstab</p>
<div class="highlight"><pre><span class="code-line"><span></span>/dev/sdc1 /export/data0 ext4 defaults 1 1</span>
<span class="code-line">/dev/sdc2 /export/data1 ext4 defaults 1 1</span>
<span class="code-line">/dev/sde1 /export/data5 ext4 defaults 1 1</span>
<span class="code-line">/dev/mapper/mpathhp1 /export/data4 xfs defaults,_netdev 0 0</span>
<span class="code-line">/dev/mapper/mpathep1 /export/data2 xfs defaults,_netdev 0 0</span>
<span class="code-line">/dev/mapper/mpathfp1 /export/data3 xfs defaults,_netdev 0 0</span>
</pre></div>


</li>
<li>
<p>autofs自动挂载</p>
<p>autofs一般与ldap、nfs协作实现远程home目录。</p>
</li>
<li>
<p>确认/export/*,一般重启服务</p>
<div class="highlight"><pre><span class="code-line"><span></span>service autofs restart</span>
</pre></div>


</li>
<li>
<p>/etc/auto.master</p>
<div class="highlight"><pre><span class="code-line"><span></span>/share /etc/auto.share --timeout<span class="o">=</span><span class="m">1200</span></span>
<span class="code-line">/home /etc/auto.home  --timeout<span class="o">=</span><span class="m">1200</span></span>
</pre></div>


</li>
<li>
<p>/etc/auto.share</p>
<div class="highlight"><pre><span class="code-line"><span></span>apps -nfsvers<span class="o">=</span><span class="m">3</span> -soft,intr,timeo<span class="o">=</span><span class="m">9999</span>  xmu.local:/export/<span class="p">&amp;</span></span>
<span class="code-line"><span class="c1">#bio  -nfsvers=3 -soft,intr,timeo=9999  xmu:/export/&amp;</span></span>
<span class="code-line">data0 -nfsvers<span class="o">=</span><span class="m">3</span> -soft,intr,timeo<span class="o">=</span><span class="m">9999</span> xmu.local:/export/<span class="p">&amp;</span></span>
<span class="code-line">data1 -nfsvers<span class="o">=</span><span class="m">3</span> -soft,intr,timeo<span class="o">=</span><span class="m">9999</span> xmu.local:/export/<span class="p">&amp;</span></span>
<span class="code-line">data2 -nfsvers<span class="o">=</span><span class="m">3</span> -soft,intr,timeo<span class="o">=</span><span class="m">9999</span> xmu.local:/export/<span class="p">&amp;</span></span>
<span class="code-line">data3 -nfsvers<span class="o">=</span><span class="m">3</span> -soft,intr,timeo<span class="o">=</span><span class="m">9999</span> xmu.local:/export/<span class="p">&amp;</span></span>
<span class="code-line">data4 -nfsvers<span class="o">=</span><span class="m">3</span> -soft,intr,timeo<span class="o">=</span><span class="m">9999</span> xmu.local:/export/<span class="p">&amp;</span></span>
<span class="code-line">data5 -nfsvers<span class="o">=</span><span class="m">3</span> -soft,intr,timeo<span class="o">=</span><span class="m">9999</span> xmu.local:/export/<span class="p">&amp;</span></span>
</pre></div>


</li>
<li>
<p>修复分区(未完)</p>
<div class="highlight"><pre><span class="code-line"><span></span>exportfs -rv <span class="c1">#重新扫描/etc/exports</span></span>
<span class="code-line">exportfs -u /export/data2       <span class="c1">#umount分区</span></span>
<span class="code-line">xfs_check /dev/mapper/mpathep1<span class="p">;</span><span class="nb">echo</span> <span class="nv">$?</span> <span class="c1">#显示0表示已umount</span></span>
</pre></div>


</li>
</ul>
<h2>qsub</h2>
<p>1.指定运行节点</p>
<div class="highlight"><pre><span class="code-line"><span></span>qsub -l <span class="nv">nodes</span><span class="o">=</span><span class="m">1</span>:n3:ppn<span class="o">=</span><span class="m">40</span></span>
<span class="code-line">qusb -l <span class="nv">nodes</span><span class="o">=</span><span class="m">1</span>:n1:ppn<span class="o">=</span>+1:n2</span>
</pre></div>


<p>2.重新运行任务</p>
<div class="highlight"><pre><span class="code-line"><span></span>    qrerun</span>
</pre></div>


<p>3.lib</p>
<div class="highlight"><pre><span class="code-line"><span></span><span class="k">for</span> i in <span class="sb">`</span>seq <span class="m">1</span> <span class="m">8</span><span class="sb">`</span><span class="p">;</span></span>
<span class="code-line"><span class="k">do</span></span>
<span class="code-line">sudo scp /etc/profile.d/set.sh compute-0-<span class="nv">$i</span>:/etc/profile.d/set.sh</span>
<span class="code-line"><span class="k">done</span></span>
<span class="code-line">rm /usr/lib64/libstdc++.so.6</span>
<span class="code-line">ln -s /share/apps/gcc-5.3.0/lib64/libstdc++.so.6.0.21 libstdc++.so.6</span>
<span class="code-line">strings /usr/lib/libstdc++.so.6 <span class="p">|</span> grep</span>
</pre></div>


<h1>CentOS 6.5 升级内核</h1>
<div class="highlight"><pre><span class="code-line"><span></span>rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span>
<span class="code-line">rpm -Uvh http://www.elrepo.org/elrepo-release-6-8.el6.elrepo.noarch.rpm</span>
<span class="code-line">yum elrepo源有 ml（mainline 为最新版本的内核）和 lt（长期支持的内核）两种内核，这里我们选择 lt 内核</span>
<span class="code-line">yum --enablerepo<span class="o">=</span>elrepo-kernel -y install kernel-lt （kernel-ml）</span>
<span class="code-line"></span>
<span class="code-line">引导文件修改（grub.conf）</span>
<span class="code-line">将 default 设置为 <span class="m">0</span> ，default<span class="o">=</span><span class="m">0</span></span>
<span class="code-line">vim /etc/grub.conf</span>
</pre></div>


<p><img alt="图4" height="50%" src="images/manager4.png" width="50%" /></p>
<h1>使用 fail2ban 防御 SSH 服务器的暴力破解攻击</h1>
<h1>install glibc</h1>
<div class="highlight"><pre><span class="code-line"><span></span>conda install -c asmeurer glibc</span>
</pre></div>
        </div>
        <!-- <div class="tool-box">
          <a href="#" class="circle-icon small glyphicon glyphicon-share-alt"></a>
          <a href="#" class="circle-icon small red-hover glyphicon glyphicon-remove"></a>
          <a href="#" class="circle-icon small red-hover glyphicon glyphicon-flag"></a>
        </div> -->
    </ul>
  </div>
</div>

<script>
  $('.nano').overlayScrollbars({
    scrollbars: {
      autoHide: "leave",
    }
  });
  $('.trigger-message-close').on('click', function () {
    $('body').removeClass('show-message');
    $('#main .message-list li').removeClass('active');
    messageIsOpen = false;
    $('body').removeClass('show-main-overlay');
  });
  $('#message .header .left a').on('click', function (e) {
    e.preventDefault();
    helper.setQuery().clearRefinements().addDisjunctiveFacetRefinement("category", e.target.text).search();
    
  });
  $('#message .header .right a').on('click', function (e) {
    e.preventDefault();
    helper.setQuery().clearRefinements().addFacetRefinement("tags", e.target.text).search();
  });
</script>